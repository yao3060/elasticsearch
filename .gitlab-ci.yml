variables:
  GIT_STRATEGY: fetch
  GIT_DEPTH: 1

cache:
  key: ${CI_PROJECT_NAME}_3
  paths:
    - src/vendor

stages:
  - install
  - build
  - deploy

before_script:
  - set -aeu
  # - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.gitlab.com
  - docker login --username=$ALIYUN_USERNAME $ALIYUN_CONTAINER_REGISTRY --password=$DOCKER_PASSWORD
  - cp .env.default .env

after_script:
  - source .env
  - ./deploy/scripts/clean-docker-network.sh  "${PROJECT}_${ENVIRONMENT}_default"

###########################################################################

staging-install-job:
  stage: install
  environment:
    name: staging
  image: composer:2
  tags:
    - yaoin-net:aliyun-small-2
  script:
    - cd ./src
    - echo "Start install php packages"
    - composer install --ignore-platform-reqs
    - composer dump-autoload
    - cd ../

build-staging-job:
  stage: build
  environment:
    name: staging
  tags:
    - yaoin-net:aliyun-small-2
  only:
    - develop
  script:
    # - ./deploy/scripts/enable-docker-compose-network.sh
    - ./deploy/scripts/update-resource-mirror.sh
    - ./deploy/scripts/modify-dot-env-staging.sh
    - sed -i "1 s|$|-${CI_COMMIT_SHA:0:8}|" VERSION
    - source ./.env
    - export COMPOSE_PROJECT_NAME="${PROJECT}_${ENVIRONMENT}"
    - export VERSION=$(cat VERSION)
    - echo $VERSION
    - echo "ready to build and push to Aliyun CS"
    - ./deploy/scripts/deploy-to-aliyun-cs.sh nginx php
    - echo "built successfully"
  # when: manual
